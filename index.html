<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AllPlay üé∂</title>
  <link rel="icon" href="/allplay-icon.png" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg: #f9f9fb;
      --text: #111;
      --accent: #ff4b5c;
      --card: #ffffff;
      --glass: rgba(255, 255, 255, 0.7);
      --glass-dark: rgba(0, 0, 0, 0.5);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition-duration: 0.4s; /* For smooth transitions */
    }

    [data-theme="dark"] {
      --bg: #121212;
      --text: #f5f5f5;
      --card: #1e1e1e;
      --glass: rgba(255, 255, 255, 0.1);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      transition: all 0.3s ease; /* Keep general transitions */
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }

    /* Responsive Navigation */
    .navbar {
      position: fixed;
      width: 100%;
      top: 0;
      background: var(--glass);
      backdrop-filter: blur(15px);
      box-shadow: var(--shadow);
      z-index: 999;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
    }

    .nav-links {
      display: flex;
      gap: 40px;
    }

    .nav-links a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      font-size: 18px;
      position: relative;
      padding: 5px 0; /* Add padding for better touch target */
    }

    .nav-links a.active::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
    }

    .hamburger-menu {
      display: none; /* Hidden by default on larger screens */
      flex-direction: column;
      cursor: pointer;
      padding: 5px;
    }

    .hamburger-menu .bar {
      width: 25px;
      height: 3px;
      background-color: var(--text);
      margin: 4px 0;
      transition: 0.4s;
    }

    /* Styles for mobile navigation */
    @media (max-width: 768px) {
      .nav-links {
        display: none; /* Hide nav links by default on small screens */
        flex-direction: column;
        width: 100%;
        position: absolute;
        top: 60px; /* Adjust based on navbar height */
        left: 0;
        background: var(--glass);
        box-shadow: var(--shadow);
        padding: 10px 20px;
        align-items: flex-start;
        gap: 15px;
      }

      .nav-links.active {
        display: flex; /* Show nav links when active */
      }

      .hamburger-menu {
        display: flex; /* Show hamburger menu on small screens */
      }

      .navbar {
        justify-content: space-between; /* Space out items */
      }

      /* Animate hamburger to X */
      .hamburger-menu.open .bar:nth-child(1) {
        transform: rotate(-45deg) translate(-5px, 6px);
      }
      .hamburger-menu.open .bar:nth-child(2) {
        opacity: 0;
      }
      .hamburger-menu.open .bar:nth-child(3) {
        transform: rotate(45deg) translate(-5px, -6px);
      }
    }


    .theme-toggle {
      position: static; /* Adjusted for navbar flow */
      background: var(--glass);
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--text);
      font-size: 16px;
      z-index: 1000;
    }

    .page {
      position: absolute; /* Changed for transitions */
      top: 0;
      left: 0;
      width: 100%;
      max-width: 900px;
      margin: 100px auto 40px;
      padding: 0 20px;
      opacity: 0;
      pointer-events: none; /* Prevents interaction when hidden */
      transform: translateY(20px); /* Initial transform for entrance */
      transition: opacity var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
      z-index: 1; /* For stacking during transitions */
    }

    .page.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
      position: relative; /* Bring back to normal flow for active page */
      z-index: 2;
    }

    header h1 {
      text-align: center;
      color: var(--accent);
      font-size: 2.8rem;
      margin-bottom: 25px;
    }

    .input-group {
      position: relative;
      display: flex;
      align-items: center;
      background: var(--card);
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: var(--shadow);
      max-width: 500px;
      margin: 20px auto;
      border: 2px solid transparent;
    }

    .input-group.active {
      border-color: var(--accent);
    }

    .input-group::before {
      content: "üîç";
      margin-right: 10px;
      font-size: 20px;
      color: var(--accent);
    }

    .input-group input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 16px;
      color: var(--text);
    }

    .clear-btn {
      display: none;
      background: none;
      border: none;
      font-size: 20px;
      color: var(--accent);
      cursor: pointer;
    }

    #searchButton {
      display: block;
      margin: 10px auto 10px;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
    }

    #loadingText {
      text-align: center;
      color: var(--accent);
      font-size: 16px;
      margin-bottom: 20px;
      display: none;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      background: var(--card);
      border-radius: 14px;
      margin: 15px 0;
      padding: 15px;
      box-shadow: var(--shadow);
      cursor: pointer;
      overflow: hidden;
      transition: transform 0.2s ease;
    }

    li:hover {
      transform: translateY(-3px);
    }

    .content-row {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    li img {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      object-fit: cover;
    }

    li p {
      flex: 1;
      margin: 0;
      font-weight: 600;
      font-size: 16px;
    }

    .video-wrapper iframe {
      width: 100%;
      height: 360px;
      border: none;
      border-radius: 12px;
      margin-top: 15px;
    }

    button.small-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    /* New styles for playlists */
    .playlist-management {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Allow wrapping on small screens */
    }
    .playlist-management button, .playlist-management input {
      padding: 8px 15px;
      border-radius: 8px;
      border: 1px solid var(--accent);
      background: var(--card);
      color: var(--text);
    }
    .playlist-management button {
      background: var(--accent);
      color: white;
      cursor: pointer;
    }
    .playlist-selector {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--accent);
        background: var(--card);
        color: var(--text);
        margin-bottom: 15px;
        max-width: 400px; /* Limit width */
        margin-left: auto;
        margin-right: auto;
        display: block;
    }

    /* Waveform Visualizer Placeholder */
    #waveformVisualizer {
      width: 100%;
      height: 80px; /* Adjust height as needed */
      background: linear-gradient(to right, var(--accent) 0%, rgba(255, 75, 92, 0.3) 100%);
      border-radius: 10px;
      margin-top: 15px;
      display: none; /* Will be shown when a video is playing */
      overflow: hidden;
      position: relative;
    }

    .waveform-bar {
      position: absolute;
      bottom: 0;
      width: 2px; /* Width of each bar */
      background-color: var(--text);
      animation: waveform-animation 1s infinite alternate ease-in-out;
    }

    @keyframes waveform-animation {
      0% { height: 10%; }
      50% { height: 80%; }
      100% { height: 10%; }
    }

    /* Individual bar animations - adjusted for more bars/even distribution */
    /* You can generate more of these with a loop or a preprocessor */
    .waveform-bar:nth-child(1) { left: 2.5%; animation-delay: 0s; }
    .waveform-bar:nth-child(2) { left: 5%; animation-delay: -0.05s; }
    .waveform-bar:nth-child(3) { left: 7.5%; animation-delay: -0.1s; }
    .waveform-bar:nth-child(4) { left: 10%; animation-delay: -0.15s; }
    .waveform-bar:nth-child(5) { left: 12.5%; animation-delay: -0.2s; }
    .waveform-bar:nth-child(6) { left: 15%; animation-delay: -0.25s; }
    .waveform-bar:nth-child(7) { left: 17.5%; animation-delay: -0.3s; }
    .waveform-bar:nth-child(8) { left: 20%; animation-delay: -0.35s; }
    .waveform-bar:nth-child(9) { left: 22.5%; animation-delay: -0.4s; }
    .waveform-bar:nth-child(10) { left: 25%; animation-delay: -0.45s; }
    .waveform-bar:nth-child(11) { left: 27.5%; animation-delay: -0.5s; }
    .waveform-bar:nth-child(12) { left: 30%; animation-delay: -0.55s; }
    .waveform-bar:nth-child(13) { left: 32.5%; animation-delay: -0.6s; }
    .waveform-bar:nth-child(14) { left: 35%; animation-delay: -0.65s; }
    .waveform-bar:nth-child(15) { left: 37.5%; animation-delay: -0.7s; }
    .waveform-bar:nth-child(16) { left: 40%; animation-delay: -0.75s; }
    .waveform-bar:nth-child(17) { left: 42.5%; animation-delay: -0.8s; }
    .waveform-bar:nth-child(18) { left: 45%; animation-delay: -0.85s; }
    .waveform-bar:nth-child(19) { left: 47.5%; animation-delay: -0.9s; }
    .waveform-bar:nth-child(20) { left: 50%; animation-delay: -0.95s; }
    .waveform-bar:nth-child(21) { left: 52.5%; animation-delay: -1.0s; }
    .waveform-bar:nth-child(22) { left: 55%; animation-delay: -1.05s; }
    .waveform-bar:nth-child(23) { left: 57.5%; animation-delay: -1.1s; }
    .waveform-bar:nth-child(24) { left: 60%; animation-delay: -1.15s; }
    .waveform-bar:nth-child(25) { left: 62.5%; animation-delay: -1.2s; }
    .waveform-bar:nth-child(26) { left: 65%; animation-delay: -1.25s; }
    .waveform-bar:nth-child(27) { left: 67.5%; animation-delay: -1.3s; }
    .waveform-bar:nth-child(28) { left: 70%; animation-delay: -1.35s; }
    .waveform-bar:nth-child(29) { left: 72.5%; animation-delay: -1.4s; }
    .waveform-bar:nth-child(30) { left: 75%; animation-delay: -1.45s; }
    .waveform-bar:nth-child(31) { left: 77.5%; animation-delay: -1.5s; }
    .waveform-bar:nth-child(32) { left: 80%; animation-delay: -1.55s; }
    .waveform-bar:nth-child(33) { left: 82.5%; animation-delay: -1.6s; }
    .waveform-bar:nth-child(34) { left: 85%; animation-delay: -1.65s; }
    .waveform-bar:nth-child(35) { left: 87.5%; animation-delay: -1.7s; }
    .waveform-bar:nth-child(36) { left: 90%; animation-delay: -1.75s; }
    .waveform-bar:nth-child(37) { left: 92.5%; animation-delay: -1.8s; }
    .waveform-bar:nth-child(38) { left: 95%; animation-delay: -1.85s; }
    .waveform-bar:nth-child(39) { left: 97.5%; animation-delay: -1.9s; }


    footer {
      text-align: center;
      color: #aaa;
      margin: 60px 0 20px;
      font-size: 14px;
    }

    footer a {
      color: var(--accent);
    }
  </style>
</head>
<body data-theme="light">

  <div class="navbar">
    <div class="hamburger-menu" onclick="toggleMobileMenu()">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
    <div class="nav-links" id="navLinks">
      <a href="#" onclick="switchPage('homePage', this)" class="active">Home</a>
      <a href="#" onclick="switchPage('playlistPage', this)">Playlist</a>
      <a href="#" onclick="switchPage('recentlyPlayedPage', this)">Recent</a>
    </div>
    <button class="theme-toggle" onclick="cycleTheme()">üåì</button>
  </div>

  <div id="homePage" class="page active">
    <header><h1>AllPlay üé∂</h1></header>
    <div class="input-group" id="inputGroup">
      <input type="text" id="search" placeholder="Search your favorite songs..." />
      <button class="clear-btn" id="clearSearch">√ó</button>
    </div>
    <button id="searchButton">Search</button>
    <p id="loadingText">üîÑ Searching...</p>
    <ul id="results"></ul>
  </div>

  <div id="playlistPage" class="page">
    <h2 style="text-align:center; color:var(--accent);">Your Playlists</h2>
    <div class="playlist-management">
        <input type="text" id="newPlaylistName" placeholder="New playlist name" />
        <button onclick="createNewPlaylist()">Create Playlist</button>
    </div>
    <select id="activePlaylistSelector" class="playlist-selector" onchange="switchActivePlaylist(this.value)"></select>
    <div class="playlist-management">
        <button onclick="editActivePlaylistName()">Edit Name</button>
        <button onclick="deleteActivePlaylist()">Delete Active</button>
    </div>
    <ul id="playlistItems"></ul>
    <div id="waveformVisualizer">
        <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
        <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
        <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
        <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
        <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
        <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
        <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
        <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
        <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
    </div>
  </div>

  <div id="recentlyPlayedPage" class="page">
    <h2 style="text-align:center; color:var(--accent);">Recently Played</h2>
    <ul id="recentlyPlayedList"></ul>
    <button class="small-btn" onclick="clearRecentlyPlayed()" style="display:block; margin: 20px auto;">Clear Recent</button>
  </div>

  <footer>
    <p>¬© 2023‚Äì2025 All rights reserved. <a href="https://chrohail.org/" target="_blank">Chaudhry Rohail</a></p>
  </footer>

  <script src="https://www.youtube.com/iframe_api"></script> <script>
    const apiKey = 'AIzaSyDHP2EWHt-9Pm4_L20lHeVt3Qotb8WYIZU'; // Replace with your actual API key
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clearSearch');
    const inputGroup = document.getElementById('inputGroup');
    const resultsList = document.getElementById('results');
    const playlistItems = document.getElementById('playlistItems');
    const loadingText = document.getElementById('loadingText');
    const recentlyPlayedList = document.getElementById('recentlyPlayedList');
    const waveformVisualizer = document.getElementById('waveformVisualizer');
    const activePlaylistSelector = document.getElementById('activePlaylistSelector');
    const navLinks = document.getElementById('navLinks');
    const hamburgerMenu = document.querySelector('.hamburger-menu');


    let currentVideo = null;
    let ytPlayer = null;
    let currentPlaylistIndex = -1;

    // --- Data Storage ---
    // Structure for multiple playlists
    let userPlaylists = JSON.parse(localStorage.getItem('userPlaylists')) || [{ name: 'Default Playlist', songs: [] }];
    let activePlaylistName = localStorage.getItem('activePlaylistName') || userPlaylists[0].name;
    let activePlaylist = userPlaylists.find(pl => pl.name === activePlaylistName) || userPlaylists[0];

    let recentlyPlayed = JSON.parse(localStorage.getItem('recentlyPlayed')) || [];

    const MAX_RECENTLY_PLAYED = 10;

    // --- Theme Cycle (existing) ---
    function cycleTheme() {
      const current = document.body.getAttribute("data-theme");
      const hour = new Date().getHours();
      const next = current === "light" ? "dark" : current === "dark" ? "auto" : (hour < 7 || hour >= 19 ? "dark" : "light");
      document.body.setAttribute("data-theme", next === "auto" ? (hour < 7 || hour >= 19 ? "dark" : "light") : next);
    }

    // --- Responsive Navigation ---
    function toggleMobileMenu() {
        navLinks.classList.toggle('active');
        hamburgerMenu.classList.toggle('open');
    }

    // Close mobile menu when a link is clicked
    document.querySelectorAll('.nav-links a').forEach(link => {
        link.addEventListener('click', () => {
            if (navLinks.classList.contains('active')) {
                toggleMobileMenu();
            }
        });
    });


    // --- Smooth Page Transitions (updated) ---
    let currentPageId = 'homePage'; // Track the currently active page ID

    function switchPage(newId, el) {
      const oldPage = document.getElementById(currentPageId);
      const newPage = document.getElementById(newId);

      if (oldPage) {
        oldPage.classList.remove('active');
      }

      if (newPage) {
        newPage.classList.add('active');
      }

      document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
      if (el) {
        el.classList.add('active');
      }
      currentPageId = newId; // Update current page ID

      // Refresh content for specific pages when switched to
      if (newId === 'playlistPage') {
          updatePlaylistSelector();
          updatePlaylist();
      } else if (newId === 'recentlyPlayedPage') {
          updateRecentlyPlayed();
      }
    }

    // Initialize the first page
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById(currentPageId).classList.add('active');
        updatePlaylistSelector(); // Populate playlist selector on load
        updatePlaylist(); // Show current active playlist
        requestNotificationPermission(); // Request notification permission
    });


    // --- Search Input Logic (existing) ---
    searchInput.addEventListener('input', () => {
      clearBtn.style.display = searchInput.value ? 'inline' : 'none';
      inputGroup.classList.toggle('active', !!searchInput.value);
    });

    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      resultsList.innerHTML = '';
      loadingText.style.display = 'none';
      clearBtn.style.display = 'none';
      inputGroup.classList.remove('active');
    });

    document.getElementById('searchButton').addEventListener('click', handleSearch);
    searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleSearch(); });

    // --- Search Functionality ---
    function handleSearch() {
      const query = searchInput.value.trim();
      if (!query) return alert('Please enter a search term!');

      resultsList.innerHTML = '';
      loadingText.style.display = 'block';
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&videoCategoryId=10&key=${apiKey}`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          loadingText.style.display = 'none';
          displayResults(data.items);
        })
        .catch(err => {
          loadingText.style.display = 'none';
          console.error('Error:', err);
          alert('Failed to fetch search results. Check your API key or network.');
        });
    }

    function displayResults(items) {
      resultsList.innerHTML = '';
      if (items.length === 0) {
          resultsList.innerHTML = '<p style="text-align:center;">No results found.</p>';
          return;
      }
      items.forEach(item => {
        const li = document.createElement('li');
        const row = document.createElement('div');
        row.className = 'content-row';
        row.innerHTML = `
          <img src="${item.snippet.thumbnails.default.url}" alt="${item.snippet.title}" />
          <p>${item.snippet.title}</p>
          <button class="small-btn">Save to Playlist</button>
        `;
        row.querySelector('button').onclick = e => {
          e.stopPropagation();
          saveToActivePlaylist(item.snippet.title, item.id.videoId);
        };
        li.appendChild(row);
        li.onclick = () => playVideoInline(li, item.id.videoId, item.snippet.title);
        resultsList.appendChild(li);
      });
    }

    // --- Video Playback (updated for recently played & visualizer) ---
    function playVideoInline(container, videoId, title) {
      if (currentVideo) currentVideo.remove();
      if (ytPlayer && ytPlayer.destroy) ytPlayer.destroy(); // Ensure old player is destroyed

      const wrapper = document.createElement('div');
      wrapper.className = 'video-wrapper';
      wrapper.innerHTML = `<iframe src="http://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1" allow="autoplay; encrypted-media" allowfullscreen id="ytPlayerEmbed"></iframe>`;
      container.appendChild(wrapper);
      currentVideo = wrapper;

      addRecentlyPlayed(title, videoId); // Add to recently played

      // Show waveform visualizer
      waveformVisualizer.style.display = 'block';

      // Initialize YouTube Player
      if (window.YT && window.YT.Player) {
          ytPlayer = new YT.Player('ytPlayerEmbed', {
              events: {
                  'onStateChange': onPlayerStateChange
              }
          });
      } else {
          console.warn("YouTube Iframe API not ready yet. Video playback might not fully support events.");
      }
    }

    function onPlayerStateChange(event) {
        // Hide visualizer when video ends or is paused
        if (event.data === YT.PlayerState.ENDED || event.data === YT.PlayerState.PAUSED) {
            waveformVisualizer.style.display = 'none';
        } else if (event.data === YT.PlayerState.PLAYING) {
            waveformVisualizer.style.display = 'block';
        }

        if (event.data === YT.PlayerState.ENDED) {
            sendNotification('Song Ended', `"${activePlaylist.songs[currentPlaylistIndex].title}" has finished.`);
            const next = currentPlaylistIndex + 1;
            if (next < activePlaylist.songs.length) {
                currentPlaylistIndex = next;
                const nextLi = playlistItems.children[next];
                playPlaylistVideo(nextLi, activePlaylist.songs[next].videoId, activePlaylist.songs[next].title);
            } else {
                // End of playlist
                waveformVisualizer.style.display = 'none';
                sendNotification('Playlist Ended', `"${activePlaylist.name}" has finished.`);
            }
        }
    }


    // --- Multiple Playlists Logic ---
    function saveUserPlaylists() {
        localStorage.setItem('userPlaylists', JSON.stringify(userPlaylists));
        localStorage.setItem('activePlaylistName', activePlaylistName);
    }

    function updatePlaylistSelector() {
        activePlaylistSelector.innerHTML = '';
        if (userPlaylists.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No Playlists';
            activePlaylistSelector.appendChild(option);
            return;
        }

        userPlaylists.forEach(pl => {
            const option = document.createElement('option');
            option.value = pl.name;
            option.textContent = pl.name;
            activePlaylistSelector.appendChild(option);
        });
        activePlaylistSelector.value = activePlaylistName;
    }

    function switchActivePlaylist(name) {
        if (!name) return; // Prevent switching to empty name if no playlists
        activePlaylistName = name;
        activePlaylist = userPlaylists.find(pl => pl.name === activePlaylistName) || userPlaylists[0];
        saveUserPlaylists();
        updatePlaylist(); // Reload playlist items for the new active playlist
    }

    function createNewPlaylist() {
        const newNameInput = document.getElementById('newPlaylistName');
        const newName = newNameInput.value.trim();
        if (!newName) return alert('Please enter a name for the new playlist.');
        if (userPlaylists.some(pl => pl.name === newName)) return alert('A playlist with this name already exists.');

        userPlaylists.push({ name: newName, songs: [] });
        newNameInput.value = ''; // Clear input
        saveUserPlaylists();
        updatePlaylistSelector();
        switchActivePlaylist(newName); // Make the new playlist active
        sendNotification('Playlist Created', `Playlist "${newName}" has been created.`);
    }

    function editActivePlaylistName() {
        if (userPlaylists.length === 0) return alert('No playlists to edit.');
        const newName = prompt(`Enter new name for "${activePlaylistName}":`);
        if (!newName || newName.trim() === '' || newName === activePlaylistName) return;
        if (userPlaylists.some(pl => pl.name === newName.trim())) return alert('A playlist with this name already exists.');

        const index = userPlaylists.findIndex(pl => pl.name === activePlaylistName);
        if (index !== -1) {
            userPlaylists[index].name = newName.trim();
            activePlaylistName = newName.trim(); // Update active name
            saveUserPlaylists();
            updatePlaylistSelector();
            alert(`Playlist renamed to "${activePlaylistName}".`);
        }
    }

    function deleteActivePlaylist() {
        if (userPlaylists.length === 0) return alert('No playlists to delete.');
        if (userPlaylists.length === 1 && userPlaylists[0].name === activePlaylistName) {
             return alert('Cannot delete the last playlist. Create another playlist first to delete this one.');
        }
        if (!confirm(`Are you sure you want to delete the playlist "${activePlaylistName}"? This action cannot be undone.`)) return;

        userPlaylists = userPlaylists.filter(pl => pl.name !== activePlaylistName);
        activePlaylistName = userPlaylists.length > 0 ? userPlaylists[0].name : ''; // Set first playlist as active, or empty if none
        activePlaylist = userPlaylists.length > 0 ? userPlaylists[0] : { name: '', songs: [] };
        saveUserPlaylists();
        updatePlaylistSelector();
        updatePlaylist();
        alert(`Playlist "${activePlaylistName}" deleted.`);
        sendNotification('Playlist Deleted', `Playlist "${activePlaylistName}" has been deleted.`);
    }

    // --- Playlist Saving/Updating (adapted for multiple playlists) ---
    function saveToActivePlaylist(title, videoId) {
      if (userPlaylists.length === 0) {
        alert('Please create a playlist first before saving songs.');
        return;
      }
      if (activePlaylist.songs.find(song => song.videoId === videoId)) {
        sendNotification('Duplicate Song', 'üéµ Song already in this playlist!');
        return;
      }
      activePlaylist.songs.push({ title, videoId });
      saveUserPlaylists();
      updatePlaylist();
      sendNotification('Song Added', `"${title}" added to "${activePlaylistName}".`);
    }

    function updatePlaylist() {
      playlistItems.innerHTML = '';
      if (!activePlaylist || activePlaylist.songs.length === 0) {
          playlistItems.innerHTML = '<p style="text-align:center;">This playlist is empty. Add some songs!</p>';
          return;
      }
      activePlaylist.songs.forEach((song, index) => {
        const li = document.createElement('li');
        const row = document.createElement('div');
        row.className = 'content-row';
        row.innerHTML = `
          <img src="https://img.youtube.com/vi/${song.videoId}/default.jpg" alt="${song.title}" />
          <p>${song.title}</p>
          <button class="small-btn">Remove</button>
        `;
        row.querySelector('button').onclick = e => {
          e.stopPropagation();
          removeFromPlaylist(song.videoId);
        };
        li.appendChild(row);
        li.onclick = () => {
          currentPlaylistIndex = index;
          playPlaylistVideo(li, song.videoId, song.title);
        };
        playlistItems.appendChild(li);
      });
    }

    function removeFromPlaylist(videoId) {
      activePlaylist.songs = activePlaylist.songs.filter(song => song.videoId !== videoId);
      saveUserPlaylists();
      updatePlaylist();
      sendNotification('Song Removed', 'Song removed from playlist.');
    }

    function playPlaylistVideo(container, videoId, title) {
      // Re-use playVideoInline for consistent playback logic
      playVideoInline(container, videoId, title);
    }

    // --- Recently Played ---
    function addRecentlyPlayed(title, videoId) {
        // Remove if already in recently played to move it to the top
        recentlyPlayed = recentlyPlayed.filter(item => item.videoId !== videoId);
        recentlyPlayed.unshift({ title, videoId, timestamp: Date.now() }); // Add to beginning
        if (recentlyPlayed.length > MAX_RECENTLY_PLAYED) {
            recentlyPlayed = recentlyPlayed.slice(0, MAX_RECENTLY_PLAYED); // Trim
        }
        localStorage.setItem('recentlyPlayed', JSON.stringify(recentlyPlayed));
        updateRecentlyPlayed();
    }

    function updateRecentlyPlayed() {
        recentlyPlayedList.innerHTML = '';
        if (recentlyPlayed.length === 0) {
            recentlyPlayedList.innerHTML = '<p style="text-align:center;">No recently played songs.</p>';
            return;
        }
        recentlyPlayed.forEach(song => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="content-row">
                    <img src="https://img.youtube.com/vi/${song.videoId}/default.jpg" alt="${song.title}" />
                    <p>${song.title}</p>
                    <button class="small-btn">Play</button>
                </div>
            `;
            li.querySelector('button').onclick = e => {
                e.stopPropagation();
                // To play from recently played, we switch to playlist page and display the video there.
                // This might mean the user has to scroll to see it if it's not immediately visible.
                switchPage('playlistPage', document.querySelector('.nav-links a[onclick*="playlistPage"]'));
                playVideoInline(document.getElementById('playlistPage'), song.videoId, song.title); // Attach to playlist page
            };
            recentlyPlayedList.appendChild(li);
        });
    }

    function clearRecentlyPlayed() {
        if (confirm('Are you sure you want to clear your recently played list?')) {
            recentlyPlayed = [];
            localStorage.removeItem('recentlyPlayed');
            updateRecentlyPlayed();
            sendNotification('Recent Cleared', 'Recently played list has been cleared.');
        }
    }

    // --- Notifications ---
    function requestNotificationPermission() {
        if (!("Notification" in window)) {
            console.warn("This browser does not support desktop notification");
            return;
        }
        if (Notification.permission !== "granted") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    console.log("Notification permission granted.");
                } else {
                    console.warn("Notification permission denied.");
                }
            });
        }
    }

    function sendNotification(title, message) {
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification(title, {
                body: message,
                icon: '/allplay-icon.png' // Ensure this path is correct
            });
        }
    }

    // --- YouTube Iframe API Ready ---
    function onYouTubeIframeAPIReady() {
        console.log("YouTube Iframe API is ready.");
    }

    // Initial load calls
    updatePlaylistSelector();
    updatePlaylist();
    updateRecentlyPlayed();
    requestNotificationPermission();

      // Add this block towards the end of your main script, after DOMContentLoaded or similar initializations

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js') // Register your Service Worker file (sw.js)
      .then(registration => {
        console.log('Service Worker registered successfully:', registration);
      })
      .catch(error => {
        console.error('Service Worker registration failed:', error);
      });
  });
}

  </script>
</body>
</html>